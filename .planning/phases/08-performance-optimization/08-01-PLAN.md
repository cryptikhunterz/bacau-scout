---
phase: 08-performance-optimization
plan: 01
type: execute
---

<objective>
Guarantee <100ms search response times through pre-computed indexes and optimized lookups.

Purpose: Deliver the "instant" search experience that makes the tool enjoyable â€” scouts expect immediate feedback when typing.
Output: Optimized search with verified sub-100ms performance and performance logging.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ui-polish/07-01-SUMMARY.md

# Key files to modify:
@src/lib/players.ts
@src/app/api/search/route.ts
@src/app/api/player/[id]/route.ts

**Tech stack available:** Next.js 14, React, TypeScript
**Established patterns:** Memory caching in players.ts, parseMarketValue helper
**Constraining decisions:**
- [Phase 3]: JSON file as data source (MVP approach, no Supabase for search)
- [Phase 3]: 300ms debounce for search input
- [Phase 5]: parseMarketValue helper function (regex-based)
- [Phase 6]: Shared player loading logic in src/lib/players.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-compute search indexes at load time</name>
  <files>src/lib/players.ts</files>
  <action>
Optimize the player cache by pre-computing derived values at load time instead of computing them per-search:

1. Extend NormalizedPlayer interface to include pre-computed fields:
   - `nameLower: string` - lowercase name (avoid .toLowerCase() per search)
   - `marketValueNum: number | null` - parsed market value (avoid parseMarketValue() per filter)
   - `ageNum: number | null` - parsed age as number (avoid parseInt() per filter)

2. Update normalizePlayer() function to compute these fields once during load:
   - `nameLower = name.toLowerCase()`
   - `marketValueNum = parseMarketValue(marketValue)`
   - `ageNum = age ? parseInt(age, 10) : null`

3. Add a playerIdMap for O(1) lookups (Map<string, NormalizedPlayer>):
   - Build at load time alongside playersCache
   - Export as separate function or property

Keep the original fields (name, marketValue, age) unchanged for API responses.
Do NOT change the JSON file or import process.
  </action>
  <verify>
1. npm run build succeeds
2. Search still returns correct results
3. No TypeScript errors
  </verify>
  <done>
- NormalizedPlayer has nameLower, marketValueNum, ageNum fields
- normalizePlayer() populates pre-computed fields
- playerIdMap built at load time
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update search API to use pre-computed indexes</name>
  <files>src/app/api/search/route.ts</files>
  <action>
Refactor the search endpoint to use pre-computed values:

1. Name search optimization:
   - Use `p.nameLower.includes(lowerQuery)` instead of `p.name.toLowerCase().includes(lowerQuery)`
   - `lowerQuery` still computed once from user input

2. Market value filter optimization:
   - Use `p.marketValueNum` directly instead of calling `parseMarketValue(p.marketValue)`
   - Compare numbers directly: `p.marketValueNum >= minValue`

3. Age filter optimization:
   - Use `p.ageNum` directly instead of `parseInt(p.age, 10)`
   - Compare numbers directly: `p.ageNum >= minAge`

4. Add performance logging (console.log for now):
   - Record start time at request entry
   - Record end time before response
   - Log: `[Search] query="${q}" filters=${filterCount} results=${results.length} time=${duration}ms`

Do NOT remove the original fields from API response (name, marketValue, age as strings).
Do NOT change the response format - clients expect SearchPlayer type.
  </action>
  <verify>
1. npm run build succeeds
2. Search for "messi" returns correct results with performance log
3. Filter by age (20-25) returns correct results
4. Filter by value (1000000-5000000) returns correct results
5. Performance log shows time in ms
  </verify>
  <done>
- Search uses nameLower instead of runtime toLowerCase()
- Filters use pre-computed numeric values
- Performance logging present
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Optimize player detail lookup with Map</name>
  <files>src/lib/players.ts, src/app/api/player/[id]/route.ts</files>
  <action>
Optimize the findPlayerById function to use O(1) Map lookup:

1. In players.ts:
   - Ensure playerIdMap is populated during loadPlayers()
   - Update findPlayerById() to use Map lookup first:
     ```
     const fromMap = playerIdMap.get(id);
     if (fromMap) return fromMap;
     ```
   - Keep name fallback as O(n) (rare path, only for URL-based IDs)

2. In player/[id]/route.ts:
   - Add performance logging similar to search:
   - Log: `[Player] id="${id}" found=${!!player} time=${duration}ms`

3. Export a function to get the Map size for verification:
   - `export function getPlayerCount(): number`

Do NOT change the findPlayerById return type or behavior.
  </action>
  <verify>
1. npm run build succeeds
2. Player detail page loads correctly (visit /player/820633 or similar)
3. Performance log shows lookup time
4. getPlayerCount() returns 576 (or current count)
  </verify>
  <done>
- findPlayerById uses Map for O(1) lookup
- Performance logging in player detail API
- getPlayerCount() function exported
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Search returns correct results (test "messi", "ronaldo")
- [ ] Filters work correctly (test age 20-25, value range)
- [ ] Player detail page loads correctly
- [ ] Performance logs show sub-100ms times
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Search performance logged and verified <100ms
- No regression in search results or filters
- Player detail lookup optimized
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-optimization/08-01-SUMMARY.md`:

# Phase 8 Plan 01: Performance Optimization Summary

**[Substantive one-liner]**

## Performance

- **Duration:** X min
- **Started:** timestamp
- **Completed:** timestamp
- **Tasks:** 3
- **Files modified:** N

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Task Commits

1. **Task 1: Pre-compute search indexes** - `hash` (feat)
2. **Task 2: Optimize search API** - `hash` (feat)
3. **Task 3: Optimize player detail lookup** - `hash` (feat)

## Files Created/Modified

- `src/lib/players.ts` - Pre-computed fields, playerIdMap
- `src/app/api/search/route.ts` - Use pre-computed values, performance logging
- `src/app/api/player/[id]/route.ts` - Performance logging

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| ... | ... |

## Deviations from Plan

None / describe any

## Issues Encountered

None / describe any

## Next Phase Readiness

Phase 8 complete. Milestone complete:
- All 8 phases delivered
- Clean UX with fast search (<100ms)
- Ready for user testing or deployment
</output>
