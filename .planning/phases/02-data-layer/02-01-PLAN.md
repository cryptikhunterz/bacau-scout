---
phase: 02-data-layer
plan: 01
type: execute
---

<objective>
Create Postgres database schema and import 2,584 players from JSON file.

Purpose: Establish the data foundation that all search and browsing features depend on.
Output: Players table with searchable data, import script for future refreshes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Tech stack available:** Next.js 14, Tailwind CSS, Supabase client (@supabase/supabase-js)
**Supabase project:** fuubyhubptalxwondwov.supabase.co

**JSON data file:** ~/Desktop/Bacau scout prototype /JSON 2.json
**Data structure (from inspection):**
```json
{
  "Player": ["Dominic Vavassori", "Second Striker"],  // [name, position]
  "Age": "20",  // string
  "Club": "Atalanta U23",  // string
  "Market value": "€2.00m",  // string with € prefix, m/k suffix
  "givenUrl": "https://www.transfermarkt.com/...",  // league URL
  "Nat.": ["Italy", "Brazil"]  // string OR array for dual nationals
}
```

**Constraining decisions from Phase 1:**
- Project at ~/Desktop/bacau-scout/
- Supabase anon key placeholder used (need real key from dashboard)

**Market value parsing requirements:**
- "€2.00m" → 2000000 (numeric cents for filtering)
- "€900k" → 900000
- "€50.00m" → 50000000
- Store both numeric (for queries) and display string (for UI)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema via Supabase SQL Editor</name>
  <files>supabase/schema.sql</files>
  <action>
Create SQL schema file with players table:

```sql
-- Players table for Bacau Scout
CREATE TABLE IF NOT EXISTS players (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  position TEXT NOT NULL,
  age INTEGER NOT NULL,
  club TEXT NOT NULL,
  market_value_cents BIGINT NOT NULL,  -- Stored in cents for precision
  market_value_display TEXT NOT NULL,   -- Original format "€2.00m" for UI
  nationality TEXT[] NOT NULL,          -- Array for dual nationals
  league_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for search (name, club)
CREATE INDEX IF NOT EXISTS idx_players_name ON players USING gin (to_tsvector('simple', name));
CREATE INDEX IF NOT EXISTS idx_players_club ON players (club);
CREATE INDEX IF NOT EXISTS idx_players_position ON players (position);
CREATE INDEX IF NOT EXISTS idx_players_age ON players (age);
CREATE INDEX IF NOT EXISTS idx_players_market_value ON players (market_value_cents);

-- Enable Row Level Security (public read for MVP)
ALTER TABLE players ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read access" ON players FOR SELECT USING (true);
```

Store in `supabase/schema.sql` for reference. Instruct user to run via Supabase SQL Editor (no CLI setup for MVP).
  </action>
  <verify>File exists at supabase/schema.sql with complete schema</verify>
  <done>Schema file created with players table, indexes, and RLS policy</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Apply database schema via Supabase dashboard</action>
  <instructions>
I created the schema file. You need to run it in Supabase:

1. Go to: https://supabase.com/dashboard/project/fuubyhubptalxwondwov/sql/new
2. Copy contents of `supabase/schema.sql`
3. Paste into SQL Editor
4. Click "Run"
5. Verify: Go to Table Editor, confirm `players` table exists

Also get your anon key while you're there:
1. Go to: Settings > API
2. Copy the `anon` key (public)
3. Update `.env.local` with real key
  </instructions>
  <verification>Table exists in Supabase Table Editor, .env.local has real anon key</verification>
  <resume-signal>Type "done" when schema is applied and anon key is set</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create and run import script</name>
  <files>scripts/import-players.ts, src/types/player.ts</files>
  <action>
Create TypeScript import script that:

1. **Type definition** (`src/types/player.ts`):
```typescript
export interface Player {
  id?: string;
  name: string;
  position: string;
  age: number;
  club: string;
  market_value_cents: number;
  market_value_display: string;
  nationality: string[];
  league_url: string | null;
}

// Raw JSON format from Transfermarkt scrape
export interface RawPlayerData {
  Player: [string, string];  // [name, position]
  Age: string;
  Club: string;
  "Market value": string;
  givenUrl: string;
  "Nat.": string | string[];
}
```

2. **Import script** (`scripts/import-players.ts`):
- Read JSON file from path (passed as argument or hardcoded)
- Parse market value: "€2.00m" → 2000000, "€900k" → 900000
- Transform each record to Player type
- Batch insert to Supabase (100 records per batch to avoid timeouts)
- Log progress and any errors

Market value parsing logic:
```typescript
function parseMarketValue(value: string): number {
  // Remove € symbol and whitespace
  const cleaned = value.replace('€', '').trim();

  // Extract number and suffix
  const match = cleaned.match(/^([\d.]+)(m|k)?$/i);
  if (!match) return 0;

  const num = parseFloat(match[1]);
  const suffix = match[2]?.toLowerCase();

  if (suffix === 'm') return Math.round(num * 1000000);
  if (suffix === 'k') return Math.round(num * 1000);
  return Math.round(num);
}
```

Run with: `npx tsx scripts/import-players.ts`

Handle errors gracefully - log failures but continue importing.
  </action>
  <verify>npx tsx scripts/import-players.ts completes without errors, logs "Imported X players"</verify>
  <done>All ~2,584 players imported to Supabase, visible in Table Editor</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `supabase/schema.sql` exists with complete schema
- [ ] Players table exists in Supabase with correct columns
- [ ] Import script runs successfully
- [ ] ~2,584 players visible in Supabase Table Editor
- [ ] Sample query works: `SELECT * FROM players LIMIT 10`
</verification>

<success_criteria>

- Schema file created and applied to Supabase
- Import script runs and loads all players
- Data is queryable via Supabase client
- Ready for Phase 3: Player Search
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-layer/02-01-SUMMARY.md` following summary template.
</output>
